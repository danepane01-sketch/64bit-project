name: AI Monitor

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *' # setiap 30 menit, opsional

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  run-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: |
          npm init -y
          npm i node-fetch@2 @octokit/rest

      - name: Run AI agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          cat > agent.js <<'EOF'
          const fetch = require('node-fetch');
          const { Octokit } = require('@octokit/rest');
          const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });

          (async () => {
            try {
              // Ambil konteks event: commit message / PR / dll
              const repo = process.env.GITHUB_REPOSITORY;
              const [owner, repoName] = repo.split('/');
              const event = process.env.GITHUB_EVENT_NAME || 'manual';

              // contoh: ambil 5 latest commits message (bila push)
              let contextText = `Event: ${event}\nRef: ${process.env.GITHUB_REF}\n`;

              // (Opsional) ambil latest commit messages
              try {
                const commits = await octokit.repos.listCommits({ owner, repo: repoName, per_page: 5 });
                contextText += "Latest commits:\\n";
                commits.data.forEach(c => {
                  contextText += `- ${c.commit.message}\\n`;
                });
              } catch (e) {
                // ignore
              }

              // Panggil OpenAI untuk analisis / rekomendasi tindakan
              const prompt = `Kamu adalah asisten dev yang bertugas menjaga repo GitHub ini. 
              Ringkas konteks berikut secara singkat, lalu sarankan 1 tindakan konkret (create_issue / comment / open_pr / noop). 
              Tindakan harus disertai judul dan body jika create_issue atau open_pr. 
              Konten:\n\n${contextText}`;

              const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                  model: "gpt-4o-mini", // ganti sesuai availability / cost
                  messages: [{ role: "user", content: prompt }],
                  max_tokens: 400
                })
              });

              const j = await resp.json();
              const aiText = j.choices?.[0]?.message?.content || j.choices?.[0]?.text || '';

              // Expecting AI to respond structured (simple parsing)
              // Format contoh yang diharapkan dari AI:
              // ACTION: create_issue
              // TITLE: ...
              // BODY: ...
              const lines = aiText.split('\n').map(l => l.trim()).filter(Boolean);
              let action = 'noop', title='', body='';
              lines.forEach(l=>{
                if (l.toUpperCase().startsWith('ACTION:')) action = l.split(':').slice(1).join(':').trim();
                if (l.toUpperCase().startsWith('TITLE:')) title = l.split(':').slice(1).join(':').trim();
                if (l.toUpperCase().startsWith('BODY:')) body = l.split(':').slice(1).join(':').trim();
              });

              console.log('AI raw output:\\n', aiText);
              console.log('Parsed action:', action);

              if (action === 'create_issue' && title) {
                await octokit.issues.create({ owner, repo: repoName, title, body: body || 'No details provided by AI.' });
                console.log('Issue created:', title);
              } else if (action === 'comment' && body) {
                // comment latest PR if exists
                const prs = await octokit.pulls.list({ owner, repo: repoName, per_page: 1 });
                if (prs.data.length) {
                  const pr = prs.data[0];
                  await octokit.issues.createComment({ owner, repo: repoName, issue_number: pr.number, body });
                  console.log('Commented on PR:', pr.number);
                }
              } else {
                console.log('No actionable instruction from AI or noop.');
              }

            } catch (err) {
              console.error('Agent error:', err);
              process.exit(1);
            }
          })();
          EOF

          node agent.js
